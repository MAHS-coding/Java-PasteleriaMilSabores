name: CI-CD (Docker & ECR & Lambda)

on:
  push:
    branches: [ feature, main ]
  pull_request:
    branches: [ feature, main ]

env:
  ECR_REPOSITORY_PREFIX: ${{ secrets.ECR_PREFIX }}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: temurin
          cache: maven

      - name: Make mvnw executable (modules)
        run: |
          chmod +x usuario-microservice/mvnw || true
          chmod +x core-microservice/mvnw || true
          chmod +x carrito-microservice/mvnw || true
          chmod +x api-gateway/mvnw || true

      - name: Build Java modules (package jars)
        run: |
          set -e
          MODULES=("usuario-microservice" "core-microservice" "carrito-microservice" "api-gateway")
          for m in "${MODULES[@]}"; do
            if [ -d "$m" ]; then
              echo "Building module: $m"
              if [ -f "$m/mvnw" ]; then
                (cd "$m" && ./mvnw -B -V -ntp -T 1C clean package -DskipTests)
              else
                (cd "$m" && mvn -B -V -ntp -T 1C clean package -DskipTests)
              fi
            else
              echo "Skipping missing module: $m"
            fi
          done

      - name: Log in to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build and push carrito image
        uses: docker/build-push-action@v4
        with:
          context: ./carrito-microservice
          file: ./carrito-microservice/Dockerfile
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY_PREFIX }}/carrito:latest

      - name: Build and push core image
        uses: docker/build-push-action@v4
        with:
          context: ./core-microservice
          file: ./core-microservice/Dockerfile
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY_PREFIX }}/core:latest

      - name: Build and push usuario image
        uses: docker/build-push-action@v4
        with:
          context: ./usuario-microservice
          file: ./usuario-microservice/Dockerfile
          push: true
          tags: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY_PREFIX }}/usuario:latest

      - name: Build Lambda (process-sqs)
        working-directory: lambda/process-sqs
        run: |
          if [ -f ./mvnw ]; then
            ./mvnw -B -V -ntp -T 1C clean package -DskipTests
          else
            mvn -B -V -ntp -T 1C clean package -DskipTests
          fi

      - name: Upload Lambda jar to S3
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
        run: |
          if [ -z "$S3_BUCKET" ]; then
            echo "S3_BUCKET not set; skipping lambda upload"; exit 0
          fi
          aws s3 cp lambda/process-sqs/target/process-sqs-0.0.1.jar s3://$S3_BUCKET/process-sqs-0.0.1.jar || true

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Ensure ECR repositories exist
        run: |
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY_PREFIX }}/carrito" || aws ecr create-repository --repository-name "${{ env.ECR_REPOSITORY_PREFIX }}/carrito"
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY_PREFIX }}/core" || aws ecr create-repository --repository-name "${{ env.ECR_REPOSITORY_PREFIX }}/core"
          aws ecr describe-repositories --repository-names "${{ env.ECR_REPOSITORY_PREFIX }}/usuario" || aws ecr create-repository --repository-name "${{ env.ECR_REPOSITORY_PREFIX }}/usuario"

      - name: Create SQS queue
        id: create_sqs
        run: |
          # Create queue if missing and capture the queue URL
          QUEUE_URL=$(aws sqs create-queue --queue-name milsabores-queue --output text --query 'QueueUrl' 2>/dev/null || aws sqs get-queue-url --queue-name milsabores-queue --output text --query 'QueueUrl')
          echo "QUEUE_URL=$QUEUE_URL" >> $GITHUB_OUTPUT
          # Retrieve the QueueArn
          QUEUE_ARN=$(aws sqs get-queue-attributes --queue-url $QUEUE_URL --attribute-names QueueArn --output text --query 'Attributes.QueueArn')
          echo "QUEUE_ARN=$QUEUE_ARN" >> $GITHUB_OUTPUT

      - name: Create or update Lambda (from S3)
        env:
          S3_BUCKET: ${{ secrets.S3_BUCKET }}
          LAMBDA_NAME: milsabores-process-sqs
        run: |
          if [ -z "$S3_BUCKET" ]; then
            echo "S3_BUCKET not set; skipping lambda create/update"; exit 0
          fi
          ARN=$(aws lambda list-functions --query "Functions[?FunctionName=='$LAMBDA_NAME'].FunctionArn" --output text)
          if [ -z "$ARN" ]; then
            echo "Creating Lambda $LAMBDA_NAME"
            aws lambda create-function --function-name $LAMBDA_NAME --runtime java17 --handler milsabores.lambda.ProcessSqsHandler::handleRequest --role ${{ secrets.LAMBDA_EXEC_ROLE }} --code S3Bucket=$S3_BUCKET,S3Key=process-sqs-0.0.1.jar --timeout 30 --memory-size 512
          else
            echo "Updating Lambda code for $LAMBDA_NAME"
            aws lambda update-function-code --function-name $LAMBDA_NAME --s3-bucket $S3_BUCKET --s3-key process-sqs-0.0.1.jar
          fi

      - name: Wire SQS -> Lambda (event source mapping)
        env:
          LAMBDA_NAME: milsabores-process-sqs
        run: |
          # Requires previous step to have created or returned QUEUE_URL and QUEUE_ARN
          if [ -z "${{ steps.create_sqs.outputs.QUEUE_ARN }}" ]; then
            # attempt to fetch QueueArn from SQS by name
            QUEUE_URL=$(aws sqs get-queue-url --queue-name milsabores-queue --output text --query 'QueueUrl')
            QUEUE_ARN=$(aws sqs get-queue-attributes --queue-url $QUEUE_URL --attribute-names QueueArn --output text --query 'Attributes.QueueArn')
          else
            QUEUE_ARN=${{ steps.create_sqs.outputs.QUEUE_ARN }}
          fi

          echo "Using queue ARN: $QUEUE_ARN"

          # Check if an event source mapping already exists
          MAPPING_ID=$(aws lambda list-event-source-mappings --function-name $LAMBDA_NAME --event-source-arn $QUEUE_ARN --query 'EventSourceMappings[0].UUID' --output text)
          if [ "$MAPPING_ID" = "None" ] || [ -z "$MAPPING_ID" ]; then
            echo "Creating event source mapping"
            aws lambda create-event-source-mapping --function-name $LAMBDA_NAME --event-source-arn $QUEUE_ARN --batch-size 10 --enabled
          else
            echo "Updating existing event source mapping: $MAPPING_ID"
            aws lambda update-event-source-mapping --uuid $MAPPING_ID --enabled true --batch-size 10
          fi

name: Build, Push and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  # will be provided from repository secrets
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}

jobs:
  build_and_push:
    name: Build & Push images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Make mvnw executable
        run: |
          chmod +x usuario-microservice/mvnw || true
          chmod +x core-microservice/mvnw || true
          chmod +x carrito-microservice/mvnw || true
          chmod +x api-gateway/mvnw || true

      - name: Build usuario
        run: |
          cd usuario-microservice
          ./mvnw -B -DskipTests package

      - name: Build core
        run: |
          cd core-microservice
          ./mvnw -B -DskipTests package

      - name: Build carrito
        run: |
          cd carrito-microservice
          ./mvnw -B -DskipTests package

      - name: Build api-gateway
        run: |
          if [ -f api-gateway/mvnw ]; then
            cd api-gateway
            ./mvnw -B -DskipTests package || true
          fi

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push usuario image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          docker build -t $DOCKER_USERNAME/usuario:${{ github.sha }} -t $DOCKER_USERNAME/usuario:latest ./usuario-microservice
          docker push $DOCKER_USERNAME/usuario:${{ github.sha }}
          docker push $DOCKER_USERNAME/usuario:latest

      - name: Build and push core image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          docker build -t $DOCKER_USERNAME/core:${{ github.sha }} -t $DOCKER_USERNAME/core:latest ./core-microservice
          docker push $DOCKER_USERNAME/core:${{ github.sha }}
          docker push $DOCKER_USERNAME/core:latest

      - name: Build and push carrito image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          docker build -t $DOCKER_USERNAME/carrito:${{ github.sha }} -t $DOCKER_USERNAME/carrito:latest ./carrito-microservice
          docker push $DOCKER_USERNAME/carrito:${{ github.sha }}
          docker push $DOCKER_USERNAME/carrito:latest

      - name: Build and push api-gateway image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          if [ -d api-gateway ]; then
            docker build -t $DOCKER_USERNAME/api-gateway:${{ github.sha }} -t $DOCKER_USERNAME/api-gateway:latest ./api-gateway
            docker push $DOCKER_USERNAME/api-gateway:${{ github.sha }}
            docker push $DOCKER_USERNAME/api-gateway:latest
          else
            echo "No api-gateway directory present, skipping"
          fi

  deploy:
    name: Deploy to remote Swarm manager
    runs-on: ubuntu-latest
    needs: build_and_push
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare remote docker-compose (substitute DOCKER_USERNAME)
        run: |
          sed "s/\${DOCKER_USERNAME}/${{ secrets.DOCKER_USERNAME }}/g" docker-compose.yml > docker-compose.remote.yml

      - name: Start SSH agent and add key (manual, sanitized)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          echo "Preparing SSH key..."
          mkdir -p ~/.ssh
          # Remove Windows CRLF and write the key safely
          printf "%s" "$SSH_PRIVATE_KEY" | sed 's/\r$//' > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          echo "Starting ssh-agent..."
          eval "$(ssh-agent -s)"
          # Try to add key; this will fail if the key is passphrase-protected
          ssh-add ~/.ssh/deploy_key
          echo "SSH keys loaded:" 
          ssh-add -l || true
        shell: bash

      - name: Copy docker-compose to remote
        run: |
          scp -o StrictHostKeyChecking=no docker-compose.remote.yml ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }}:/home/${{ secrets.REMOTE_USER }}/docker-compose.yml

      - name: Deploy stack on remote
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} "echo '${{ secrets.DOCKER_PASSWORD }}' | docker login --username '${{ secrets.DOCKER_USERNAME }}' --password-stdin && docker stack deploy -c /home/${{ secrets.REMOTE_USER }}/docker-compose.yml pasteleria --with-registry-auth"
